datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  email             String             @unique
  password          String
  role              String             @default("Student") // or Teacher
  avatarUrl         String?
  profileImage      String?            @db.LongText
  className         String? // Text field for class name (e.g., "Educator" for Teachers, or class name for Students)
  classId           Int?
  class             Class?             @relation(fields: [classId], references: [id])
  forumThreads      ForumThread[]
  forumComments     ForumComment[]
  learningMaterials LearningMaterial[]
  notifications     Notification[]
  gameScores        GameScore[]
  chatLogs          ChatLog[]
  notifyNewForumThreads      Boolean @default(true)
  notifyNewLearningMaterials Boolean @default(true)
  notifyForumReplies         Boolean @default(true)
  resetToken        String?            @unique
  resetTokenExpiry  DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Class {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  students    User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ForumThread {
  id         Int            @id @default(autoincrement())
  title      String
  content    String         @db.Text
  attachment String?        @db.LongText
  authorId   Int
  author     User           @relation(fields: [authorId], references: [id])
  comments   ForumComment[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model ForumComment {
  id        Int         @id @default(autoincrement())
  content   String      @db.Text
  threadId  Int
  thread    ForumThread @relation(fields: [threadId], references: [id])
  authorId  Int
  author    User        @relation(fields: [authorId], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum LearningMaterialTopic {
  STRATEGI_PENYELESAIAN_MASALAH
  ALGORITMA
  PEMBOLEH_UBAH_PEMALAR_JENIS_DATA
  STRUKTUR_KAWALAN
  AMALAN_TERBAIK_PENGATURCARAAN
  STRUKTUR_DATA_MODULAR
  PEMBANGUNAN_APLIKASI
}

enum LearningMaterialType {
  NOTES
  VIDEO
  EXERCISE
}

model LearningMaterial {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String?
  topic        LearningMaterialTopic
  materialType LearningMaterialType
  authorId     Int
  author       User                  @relation(fields: [authorId], references: [id])
  fileUrl      String?
  videoUrl     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
}

enum NotificationType {
  NEW_FORUM_THREAD
  NEW_LEARNING_MATERIAL
  FORUM_REPLY
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String?
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, createdAt])
}

model GameScore {
  id          Int      @id @default(autoincrement())
  score       Int
  gameType    String   // e.g., "DEBUGGING_QUIZ"
  createdAt   DateTime @default(now())

  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model ChatLog {
  id        Int      @id @default(autoincrement())
  message   String   @db.Text // The student's prompt
  response  String?  @db.Text // Optional: The AI's answer
  createdAt DateTime @default(now())

  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}
