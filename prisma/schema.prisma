datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  email             String             @unique
  password          String
  role              String             @default("Student") // or Teacher
  avatarUrl         String?
  profileImage      String?            @db.LongText
  className         String? // Text field for class name (e.g., "Educator" for Teachers, or class name for Students)
  classId           Int?
  class             Class?             @relation(fields: [classId], references: [id])
  forumThreads      ForumThread[]
  forumComments     ForumComment[]
  learningMaterials LearningMaterial[]
  notifications     Notification[]
  gameScores        GameScore[]
  notifyNewForumThreads      Boolean @default(true)
  notifyNewLearningMaterials Boolean @default(true)
  notifyForumReplies         Boolean @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Class {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  students    User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ForumThread {
  id         Int            @id @default(autoincrement())
  title      String
  content    String         @db.Text
  attachment String?        @db.LongText
  authorId   Int
  author     User           @relation(fields: [authorId], references: [id])
  comments   ForumComment[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model ForumComment {
  id        Int         @id @default(autoincrement())
  content   String      @db.Text
  threadId  Int
  thread    ForumThread @relation(fields: [threadId], references: [id])
  authorId  Int
  author    User        @relation(fields: [authorId], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum LearningMaterialTopic {
  STRATEGI_PENYELESAIAN_MASALAH
  ALGORITMA
  PEMBOLEH_UBAH_PEMALAR_JENIS_DATA
  STRUKTUR_KAWALAN
  AMALAN_TERBAIK_PENGATURCARAAN
  STRUKTUR_DATA_MODULAR
  PEMBANGUNAN_APLIKASI
}

enum LearningMaterialType {
  NOTES
  VIDEO
  EXERCISE
}

model LearningMaterial {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String?
  topic        LearningMaterialTopic
  materialType LearningMaterialType
  authorId     Int
  author       User                  @relation(fields: [authorId], references: [id])
  fileUrl      String?
  videoUrl     String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
}

enum NotificationType {
  NEW_FORUM_THREAD
  NEW_LEARNING_MATERIAL
  FORUM_REPLY
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  title     String
  message   String?
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId, createdAt])
}

model DebuggingChallenge {
  id             String   @id @default(cuid())
  title_en       String
  title_ms       String
  description_en String
  description_ms String
  codeBlock      String   @db.Text
  buggyLineIndex Int
  explanation_en String   @db.Text
  explanation_ms String
  basePoints     Int      @default(1000)

  @@index([id])
}

model GameScore {
  id          String   @id @default(cuid())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  challengeId String
  gameType    String
  score       Int
  timeTakenMs Int
  createdAt   DateTime @default(now())

  @@index([userId])
}
